<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Tempo II — Musical Metrics: advanced tempo ear-training game. Compare and match tempos by ear.">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Tempo II — Musical Metrics">
  <meta property="og:description" content="Advanced tempo ear-training game.">
  <meta property="og:image" content="https://musicalmetrics.xyz/amtf.png">
  <meta property="og:url" content="https://musicalmetrics.xyz/tempo2">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Tempo II — Musical Metrics">
  <meta name="twitter:description" content="Advanced tempo ear-training game.">
  <meta name="twitter:image" content="https://musicalmetrics.xyz/amtf.png">
  <title>Tempo II</title>
  <link rel="canonical" href="https://musicalmetrics.xyz/tempo2">
  <link rel="icon" type="image/svg+xml" href="music-logo.svg?v=1">
  <meta name="msapplication-TileImage" content="music-logo.svg?v=1">
  <link rel="stylesheet" href="game.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
  <header class="header">
    <div class="header-container">
      <div class="header-content">
        <div class="logo-container">
          <a href="/" class="logo-link">
            <img src="music-logo-white.svg" alt="Musical Metrics Logo" class="nav-logo">
            <h1 class="logo">MUSICAL METRICS</h1>
          </a>
        </div>

        <nav class="nav">
          <a href="/dashboard" class="nav-link">DASHBOARD</a>
          <a href="/about" class="nav-link">ABOUT</a>
        </nav>

        <button class="mobile-menu-toggle" id="mobile-menu-toggle">
          <i data-lucide="menu" class="hamburger-icon"></i>
        </button>

        <div class="mobile-menu" id="mobile-menu">
          <div class="mobile-menu-links">
            <a href="/dashboard" class="mobile-menu-link">DASHBOARD</a>
            <a href="/about" class="mobile-menu-link">ABOUT</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="main-content">
    <h1>Tempo II</h1>
    <p class="subtitle">Test your internal tempo sense!</p>

    <div class="rules">
      <p>Listen to a metronome beat, then tap back at the same tempo.</p>
      <p>Click the tap area or press spacebar to tap the tempo for 5 seconds.</p>
      <p>Your score is based on how accurately you maintain the tempo.</p>
      <div class="game-center-container">
        <button id="continueBtn" class="control-button">Continue</button>
      </div>
    </div>

    <div class="game-container">
      <div class="level-display">Round <span id="levelNum">1</span></div>
      <div class="round-counter">Round <span id="roundNum">1</span> of 5</div>

      <div class="beat-indicator" id="beatIndicator"></div>

      <div class="ready-display">
        <h2 class="ready-title">Ready?</h2>
        <p class="ready-text">Tap the tempo you just heard</p>
      </div>

      <div class="tap-container">
        <div class="tap-area">
          <span class="tap-text">TAP HERE</span>
        </div>
        <div class="tap-instructions">
          <p>Click here or press SPACEBAR to tap</p>
          <p>Tap for 5 seconds to complete the round</p>
        </div>
      </div>
    </div>

    <div class="game-over">
      <div class="final-score">Final Score: <span id="finalScore">0</span>/100</div>
      <div class="game-center-align-large-gap">
        <button id="playAgainBtn" class="control-button">Play Again</button>
        <button id="homeBtn" class="control-button">Return to home</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-container">
      <div class="footer-content">
        <div class="footer-logo">
          <img src="music-logo-white.svg" alt="Musical Metrics Logo" class="footer-logo-img" />
          <span class="footer-brand">Musical Metrics</span>
        </div>
        <div class="footer-info">
          <div class="footer-links">
            <a href="https://amtf.gr" target="_blank" rel="noopener noreferrer" class="footer-link">
              <img src="amtf.png" alt="Athens Music Technology Forum" class="amtf-logo" />
              <span class="amtf-text">Athens Music Technology Forum</span>
            </a>
          </div>
          <p class="footer-copyright">© 2025 Musical Metrics. All rights reserved.</p>
        </div>
      </div>
    </div>
  </footer>

  <script>
    const metronomeAudio = new Audio('sounds/metronome.mp3');
    metronomeAudio.load();

    let level = 1;
    let maxLevels = 5;
    let roundScores = [];
    let currentTempo = null;
    let metronomeInterval = null;
    let gameActive = false;
    let gameOver = false;

    let tapTimes = [];
    let tapCountdown = null;
    let isTapping = false;

    const playAgainBtn = document.getElementById('playAgainBtn');
    const continueBtn = document.getElementById('continueBtn');
    const rulesDiv = document.querySelector('.rules');
    const levelDisplay = document.querySelector('.level-display');
    const gameOverDiv = document.querySelector('.game-over');
    const readyDisplay = document.querySelector('.ready-display');
    const tapContainer = document.querySelector('.tap-container');
    const tapArea = document.querySelector('.tap-area');
    const roundCounter = document.querySelector('.round-counter');
    const beatIndicator = document.getElementById('beatIndicator');
    const homeBtn = document.getElementById('homeBtn');

    function playMetronome() {
      tapContainer.style.display = 'none';
      readyDisplay.style.display = 'none';
      levelDisplay.style.display = 'block';
      document.getElementById('levelNum').textContent = level;
      document.getElementById('roundNum').textContent = level;

      setTimeout(() => {
        levelDisplay.style.display = 'none';
        roundCounter.style.display = 'block';
        beatIndicator.style.display = 'block';

        currentTempo = Math.floor(Math.random() * 201) + 40;

        const beatInterval = 60000 / currentTempo;

        metronomeAudio.currentTime = 0;
        metronomeAudio.play();

        beatIndicator.classList.add('active');
        setTimeout(() => beatIndicator.classList.remove('active'), 100);

        metronomeInterval = setInterval(() => {
          metronomeAudio.currentTime = 0;
          metronomeAudio.play();

          beatIndicator.classList.add('active');
          setTimeout(() => beatIndicator.classList.remove('active'), 100);
        }, beatInterval);

        setTimeout(() => {
          clearInterval(metronomeInterval);
          metronomeInterval = null;
          beatIndicator.style.display = 'none';
          showReadyScreen();
        }, 4000);
      }, 2000);
    }

    function showReadyScreen() {
      readyDisplay.style.display = 'block';

      setTimeout(() => {
        readyDisplay.style.display = 'none';
        tapContainer.style.display = 'flex';
        startTapPhase();
      }, 2000);
    }

    function startTapPhase() {
      tapTimes = [];
      isTapping = false;
      tapArea.classList.remove('tapping');

      let timeLeft = 5;
      tapCountdown = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          clearInterval(tapCountdown);
          tapCountdown = null;
          finishTapPhase();
        }
      }, 1000);
    }

    function recordTap() {
      if (!isTapping) {
        isTapping = true;
        tapArea.classList.add('tapping');
      }

      const currentTime = Date.now();
      tapTimes.push(currentTime);

      metronomeAudio.currentTime = 0;
      metronomeAudio.play();

      tapArea.style.transform = 'scale(0.95)';
      setTimeout(() => {
        tapArea.style.transform = 'scale(1)';
      }, 100);
    }

    function calculateTapScore() {
      if (tapTimes.length < 2) {
        return { tapTempo: 0, accuracy: 0 };
      }

      const intervals = [];
      for (let i = 1; i < tapTimes.length; i++) {
        intervals.push(tapTimes[i] - tapTimes[i - 1]);
      }

      const averageInterval = intervals.reduce((sum, x) => sum + x, 0) / intervals.length;
      const tapTempo = Math.round(60000 / averageInterval);

      const tempoDifference = Math.abs(tapTempo - currentTempo);
      const accuracy = Math.max(0, 100 - tempoDifference);

      return { tapTempo, accuracy };
    }

    function finishTapPhase() {
      tapArea.classList.remove('tapping');

      if (tapCountdown) {
        clearInterval(tapCountdown);
        tapCountdown = null;
      }

      const score = calculateTapScore();
      roundScores.push(score);

      level++;

      if (level > maxLevels) {
        gameActive = false;
        gameOver = true;

        const averageScore = roundScores.reduce((sum, s) => sum + s.accuracy, 0) / roundScores.length;
        const finalScore = Math.round(averageScore);

        document.getElementById('finalScore').textContent = finalScore;
        gameOverDiv.style.display = 'block';
        playAgainBtn.style.display = 'block';
        homeBtn.style.display = 'block';
        tapContainer.style.display = 'none';
        roundCounter.style.display = 'none';
      } else {
        setTimeout(() => {
          playMetronome();
        }, 1000);
      }
    }

    function startGame() {
      level = 1;
      roundScores = [];
      gameActive = true;
      gameOver = false;
      currentTempo = null;

      if (metronomeInterval) {
        clearInterval(metronomeInterval);
        metronomeInterval = null;
      }
      if (tapCountdown) {
        clearInterval(tapCountdown);
        tapCountdown = null;
      }

      rulesDiv.style.display = 'block';
      playAgainBtn.style.display = 'none';
      gameOverDiv.style.display = 'none';
      homeBtn.style.display = 'none';
      continueBtn.style.display = 'block';
      tapContainer.style.display = 'none';
      readyDisplay.style.display = 'none';
      roundCounter.style.display = 'none';
      beatIndicator.style.display = 'none';
    }

    window.addEventListener('load', startGame);

    continueBtn.addEventListener('click', () => {
      rulesDiv.style.display = 'none';
      continueBtn.style.display = 'none';
      playMetronome();
    });

    tapArea.addEventListener('mousedown', () => {
      if (gameActive && tapContainer.style.display !== 'none') {
        recordTap();
      }
    });

    tapArea.addEventListener('click', (e) => {
      e.preventDefault();
    });

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && gameActive && tapContainer.style.display !== 'none') {
        e.preventDefault();
        if (!e.repeat) recordTap();
      }
    });

    playAgainBtn.addEventListener('click', startGame);

    homeBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    tapContainer.style.display = 'none';

    lucide.createIcons();

    document.addEventListener('DOMContentLoaded', function () {
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const mobileMenu = document.getElementById('mobile-menu');

      if (mobileMenuToggle && mobileMenu) {
        mobileMenuToggle.addEventListener('click', function () {
          mobileMenu.classList.toggle('active');
          mobileMenuToggle.classList.toggle('active');
        });

        const mobileMenuLinks = mobileMenu.querySelectorAll('.mobile-menu-link');
        mobileMenuLinks.forEach(link => {
          link.addEventListener('click', function () {
            mobileMenu.classList.remove('active');
            mobileMenuToggle.classList.remove('active');
          });
        });

        document.addEventListener('click', function (event) {
          if (!mobileMenuToggle.contains(event.target) && !mobileMenu.contains(event.target)) {
            mobileMenu.classList.remove('active');
            mobileMenuToggle.classList.remove('active');
          }
        });
      }
    });
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
  <script>window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };</script>
  <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>
